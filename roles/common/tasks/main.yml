---
# This playbook contains common plays that will be run on all nodes.

- name: "Set hostname in /etc/sysconfig/network"
  lineinfile: >
    dest=/etc/sysconfig/network
    regexp=^HOSTNAME=
    line=HOSTNAME={{ inventory_hostname }}{{ hostname_suffix }}

- name: 'Set hostname using `hostname`'
  hostname: name={{ inventory_hostname }}{{ hostname_suffix }}

- include: hosts-file.yml


- name: "Check current timezone"
  shell: "timedatectl | grep -P 'Time[ ]?zone:' | awk -F ': ' '{print $2}' | awk '{print $1}'"
  register: current_timezone
  changed_when: current_timezone.stdout != '{{ timezone }}'

- name: "Set timezone"
  command: timedatectl set-timezone {{ timezone }}
  when: current_timezone.stdout != '{{ timezone }}'


- name: Install EPEL
  shell: rpm -Uvh http://mirror.sfo12.us.leaseweb.net/epel/7/x86_64/e/epel-release-7-5.noarch.rpm
    creates=/etc/yum.repos.d/epel.repo


- name: Install Remi yum repo
  shell: rpm -Uvh http://rpms.famillecollet.com/enterprise/remi-release-7.rpm
    creates=/etc/yum.repos.d/remi.repo

- name: Configure Remi yum repo
  template: src=remi.repo.j2 dest=/etc/yum.repos.d/remi.repo owner=root group=root mode=0644


- name: Upgrade all packages
  yum: name=* state=latest update_cache={{ yum_upgrade_update_cache }}


- name: Install useful utility packages
  yum: pkg={{item}} state=present
  with_items:
   - vim


- include: git.yml

- include: firewall.yml


- name: Disable SELinux
  selinux: state=disabled


- name: Add passwordless sudo to wheel group
  lineinfile: "dest=/etc/sudoers state=present regexp='^%wheel' line='%wheel ALL=(ALL) NOPASSWD: ALL'"

- name: Disable root SSH login
  lineinfile: "dest=/etc/ssh/sshd_config state=present regexp='^PermitRootLogin' line='PermitRootLogin no'"
  notify: restart sshd
